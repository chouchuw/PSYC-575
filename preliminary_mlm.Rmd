---
title: "Preliminary Results"
author: "Chou-Chun Wu"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load packages

```{r load-pkg, message=FALSE}
# Add additional packages you need
#library(psych)
library(here)  # makes reading data more consistent
library(tidyverse)  # for data manipulation and plotting
library(haven)  # for importing SPSS/SAS/Stata data
library(lme4)  # for multilevel analysis
library(lattice)  # for dotplot (working with lme4)
library(sjPlot)  # for plotting effects
library(MuMIn)  # for computing r-squared
library(r2mlm)  # for computing r-squared
library(broom.mixed)  # for summarizing results
library(modelsummary)  # for making tables
library(dplyr)
library(skimr)
library(readxl)
library(mediation)
library(lmerTest)

```

## Import Data
Read data and define two variables of interest
treated: patient in the treatment group (intervention group) and in the post period
anysymptom: has any symptom using the Geriatric Depression Scale - Short Form (GDS-SF)
```{r data-import, message=FALSE}
# Read in the data from the Web
mydata <- read_excel("MatchedData.xlsx")
mydata$treated = mydata$treatment * mydata$post
mydata$anysymptom = ifelse(mydata$Depression_Scale > 0, 1, 0)
```

## Intraclass Correlations (ICC)
1. Proportion of variance due to the higher (subclass) level
2. Average correlation between observations (patient) in the same cluster (subclass)
s8q7: On how many of the last SEVEN DAYS did you test your blood sugar?
subclass: Matched pair label using MatchIt package with propensity score and nearest one to one matching (most similar patient in intervention group to control group)
```{r ICC}
ran_int <- lmer(s8q7 ~ 1 + (1 | subclass), data = mydata)
summary(ran_int)
variance_components <- as.data.frame(VarCorr(ran_int))
between_var <- variance_components$vcov[1]
within_var <- variance_components$vcov[2]
(icc <- between_var / (between_var + within_var))
```
## Test Random Slope
Since we used the matched data (with propensity score), we started with a simple model and tested random slope.
Model equations:
Lv-1:
$$\text{s8q7}_{ij} = \beta_{0j} + e_{ij}$$
Lv-2:
$$\beta_{0j} = \gamma_{00} + \gamma_{01}\text{treated}_j + u_{0j}$$

```{r m0}
# First, no random slopes
m0 <- lmer(s8q7 ~ treated + (1| subclass), data = mydata)
summary(m0)
# Then test random slopes 
m1 <- lmer(s8q7 ~ treated + (treated| subclass), data = mydata)
summary(m1)
ranova(m1) # 
```
It is not statistically significant at 0.05 alpha level (on the boundary (0.075) after we divided the p-value by 2).

## Compare with Conventional Method (lm)
```{r msummary}
m_lm <- lm(s8q7 ~ treated, data = mydata)
msummary(list("MLM" = m1, 
              "Linear regression" = m_lm))
```
We found that using the conventional method would underestimate the standard error terms.
This indicates the importance of considering multilevel structure.

## Association between Receiving Digital Intervention and Weekly Number of Blood Sugar Testing
```{r plot}
# Plot first 10 items
sjPlot::plot_model(m1, type = "pred", terms = "treated", 
                   show.data = TRUE, title = "", 
                   dot.size = 0.5) + 
  # Add the group means
  stat_summary(data = mydata, aes(x = treated, y = s8q7), 
               fun = mean, geom = "point",
               col = "red",
               shape = 17,
               # use triangles
               size = 3, 
               alpha = 0.7)
```
This plots shows that receiving digital intervention would increase number of blood sugar testing among older adults in Taiwan.

## Is Depression Symptom A Mediator?
```{r mediation}
detach_package <- function(pkg, character.only = FALSE)
{
  if(!character.only)
  {
    pkg <- deparse(substitute(pkg))
  }
  search_item <- paste("package", pkg, sep = ":")
  while(search_item %in% search())
  {
    detach(search_item, unload = TRUE, character.only = TRUE)
  }
}
detach_package(lmerTest)

fit.totaleffect <- lmer(s8q7 ~ treated+(treated| subclass), data = mydata)
summary(fit.totaleffect)
fit.mediator <- lmer(anysymptom ~treated+(treated| subclass), data = mydata)
summary(fit.mediator)
fit.dv  <- lmer(s8q7 ~ anysymptom + treated+(treated| subclass), data = mydata)
summary(fit.dv)

results <- mediate(fit.mediator, fit.dv, treat='treated', mediator='anysymptom')
summary(results)

plot(summary(results))
```
Since ACME (average causal mediation effects) is not statistically significant, it shows that depression symptom may not be a good mediator.